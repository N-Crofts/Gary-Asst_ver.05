<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Morning Briefing</title>
  </head>
  <body style="margin:0; padding:0; background:#f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; color:#353530; line-height:1.5;">
    <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;">
      <tr>
        <td align="center" style="padding:24px 12px;">
          <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="600" style="max-width:600px; width:100%; background:#ffffff; border-radius:12px; overflow:hidden; border:1px solid #e5e7eb;">
            <!-- Header -->
            <tr>
              <td style="background:#3a5d80; padding:20px 24px; color:#ffffff;">
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
                  <tr>
                    <td style="font-size:18px; font-weight:700; letter-spacing:0.3px;">RPCK – Morning Briefing</td>
                    <td align="right" style="font-size:12px; opacity:0.95;">
                      {{ date_human or "" }}
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2" style="padding-top:6px; font-size:13px; opacity:0.95;">
                      Prepared for {{ exec_name or "Sorum Crofts" }}
                    </td>
                  </tr>
                </table>
              </td>
            </tr>

            <!-- Legend -->
            <tr>
              <td style="padding:16px 24px 0 24px;">
                <div style="font-size:13px; color:#555; margin-bottom:8px;">
                  <span style="display:inline-block; background:#eaf2f8; color:#3a5d80; border:1px solid #d7e3ee; padding:4px 8px; border-radius:999px; font-weight:600;">Today</span>
                  <span style="display:inline-block; background:#fff7ed; color:#a16207; border:1px solid #fde68a; padding:4px 8px; border-radius:999px; font-weight:600; margin-left:6px;">Action-oriented</span>
                </div>
              </td>
            </tr>

            {% if meetings and meetings|length > 0 %}
              {% for m in meetings %}
                <!-- Meeting card -->
                <tr>
                  <td style="padding:12px 24px 0 24px;">
                    <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse; background:#ffffff; border:1px solid #e5e7eb; border-radius:10px;">
                      <tr>
                        <td style="padding:14px 16px; border-left:6px solid #A42021;">
                          <!-- Title + time -->
                          <div style="display:block; margin:0 0 4px 0; font-size:16px; font-weight:800; color:#111827;">{{ m.subject }}</div>
                          <div style="font-size:12px; color:#6b7280; margin:0 0 8px 0;">
                            Starts: <strong style="color:#374151;">{{ m.start_time }}</strong>
                            {% if m.location %} &nbsp;•&nbsp; {{ m.location }}{% endif %}
                          </div>

                          <!-- Attendees -->
                          {% if m.attendees and m.attendees|length > 0 %}
                            <div style="margin:8px 0 6px 0; font-size:12px; color:#374151;">
                              <span style="font-weight:700;">Attendees:</span>
                              <div style="margin-top:6px;">
                                {% for a in m.attendees %}
                                  <span style="display:inline-block; font-size:12px; margin:4px 6px 0 0; padding:5px 8px; border-radius:999px; background:#f3f4f6; border:1px solid #e5e7eb;">
                                    {{ a.name }}{% if a.title %}, {{ a.title }}{% endif %}{% if a.company %} ({{ a.company }}){% endif %}
                                  </span>
                                {% endfor %}
                              </div>
                            </div>
                          {% endif %}

                          <!-- Company -->
                          {% if m.company %}
                            <div style="margin:10px 0; padding:8px 10px; background:#fff1f2; border:1px solid #ffe4e6; border-radius:8px; font-size:12px;">
                              <div style="font-weight:700; color:#9f1239; margin-bottom:2px;">Company</div>
                              <div style="color:#111827;">
                                <strong>{{ m.company.name }}</strong>
                                {% if m.company.one_liner %} — {{ m.company.one_liner }}{% endif %}
                              </div>
                            </div>
                          {% endif %}

                          <!-- 1) Context Snapshot: company summary, recent developments, industry signal; or subtle empty state -->
                          {% set has_context = m.context_summary or (m.news and m.news|length > 0) or m.industry_signal or (m.strategic_angles and m.strategic_angles|length > 0) or (m.high_leverage_questions and m.high_leverage_questions|length > 0) %}
                          <div style="margin:12px 0 4px 0;">
                            <div style="font-weight:800; font-size:13px; color:#0f172a; margin-bottom:6px;">Context Snapshot</div>
                            {% if has_context %}
                              {% if m.context_summary %}
                                <div style="font-size:13px; color:#374151; margin-bottom:8px; line-height:1.5;">{{ m.context_summary }}</div>
                              {% endif %}
                              {% if m.news and m.news|length > 0 %}
                                <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">Recent developments</div>
                                <ul style="margin:0; padding-left:18px; font-size:13px;">
                                  {% for n in m.news %}
                                    {% if n.title and n.url %}
                                      <li style="margin:6px 0;">
                                        <a href="{{ n.url }}" target="_blank" rel="noopener noreferrer" style="color:#3a5d80; text-decoration:underline;">{{ n.title }}</a>
                                      </li>
                                    {% else %}
                                      <li style="margin:6px 0;">{{ n }}</li>
                                    {% endif %}
                                  {% endfor %}
                                </ul>
                              {% endif %}
                              {% if m.industry_signal %}
                                <div style="font-size:12px; color:#6b7280; margin-top:6px;">Industry signal</div>
                                <div style="font-size:13px; color:#374151; line-height:1.5;">{{ m.industry_signal }}</div>
                              {% endif %}
                            {% else %}
                              <div style="padding:8px 10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; font-size:12px; color:#94a3b8;">No external context available</div>
                            {% endif %}
                            {% if m.research_trace and (app_env|default('') == 'development' or enable_research_dev|default(false)) %}
                              <div style="margin-top:6px; font-size:11px; color:#9ca3af;">
                                [Dev] Anchor={{ m.research_trace.anchor_type|default('—') }} | domain={{ m.research_trace.primary_domain|default('—') }} | domain_match={% if m.research_trace.domain_match_passed is defined and m.research_trace.domain_match_passed is not none %}{{ 'true' if m.research_trace.domain_match_passed else 'false' }}{% else %}—{% endif %}
                                | match_url={% if m.research_trace.domain_match_passed %}{{ m.research_trace.domain_match_url|default('—') }}{% else %}—{% endif %}
                                | hosts={% if m.research_trace.top_source_hosts %}{{ m.research_trace.top_source_hosts[:3]|join(',') }}{% else %}—{% endif %}
                                {% if m.research_trace.entity_match_passed is defined and m.research_trace.entity_match_passed is not none %} | entity_match={{ 'true' if m.research_trace.entity_match_passed else 'false' }}{% endif %}
                                {% if m.research_trace.skip_reason %} | skip={{ m.research_trace.skip_reason }}{% endif %}
                                {% if m.research_trace.mismatch_reason %} | mismatch={{ m.research_trace.mismatch_reason }}{% endif %}
                                {% if m.research_trace.retry_used %} | retry=true{% endif %}
                                {% if m.research_trace.outcome == 'error' %} | outcome=error{% endif %}
                              </div>
                            {% endif %}
                          </div>

                          <!-- 2) Strategic Angles: research synthesis bullets; omit section if empty -->
                          {% if m.strategic_angles and m.strategic_angles|length > 0 %}
                            <div style="margin:12px 0 4px 0;">
                              <div style="font-weight:800; font-size:13px; color:#0f172a; margin-bottom:6px;">Strategic Angles</div>
                              <ul style="margin:0; padding-left:18px; font-size:13px;">
                                {% for a in m.strategic_angles %}
                                  <li style="margin:6px 0;">{{ a }}</li>
                                {% endfor %}
                              </ul>
                            </div>
                          {% endif %}

                          <!-- 3) High-Leverage Questions: from research/context; omit section if no context -->
                          {% if m.high_leverage_questions and m.high_leverage_questions|length > 0 %}
                            <div style="margin:12px 0 0 0; padding:10px 12px; background:#eaf2e9; border:1px solid #dbe7da; border-radius:8px;">
                              <div style="font-weight:800; font-size:13px; color:#064e3b; margin-bottom:6px;">High-Leverage Questions</div>
                              <ul style="margin:0; padding-left:18px; font-size:13px;">
                                {% for q in m.high_leverage_questions %}
                                  <li style="margin:6px 0;">{{ q }}</li>
                                {% endfor %}
                              </ul>
                            </div>
                          {% endif %}

                          <!-- 4) Relationship Signal: TODO - wire recent internal interaction, past matters summary -->
                          <!-- Future: show when relationship data is available -->

                          <!-- Recent with them (Memory) -->
                          {% if m.memory and m.memory.previous_meetings and m.memory.previous_meetings|length > 0 %}
                            <div style="margin:12px 0 0 0; padding:10px 12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px;">
                              <div style="font-weight:800; font-size:13px; color:#475569; margin-bottom:6px;">Recent with them</div>
                              <ul style="margin:0; padding-left:18px; font-size:13px;">
                                {% for past in m.memory.previous_meetings %}
                                  <li style="margin:6px 0; color:#64748b;">
                                    <strong style="color:#475569;">{{ past.date }}</strong> — {{ past.subject }}
                                    {% if past.key_attendees and past.key_attendees|length > 0 %}
                                      <br><span style="font-size:12px; color:#94a3b8;">with {{ past.key_attendees|join(", ") }}</span>
                                    {% endif %}
                                  </li>
                                {% endfor %}
                              </ul>
                            </div>
                          {% else %}
                            <!-- Gentle empty state for memory -->
                            <div style="margin:12px 0 0 0; padding:10px 12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; font-size:12px; color:#64748b;">
                              <span style="font-weight:600;">Recent with them:</span> Not available
                            </div>
                          {% endif %}
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <!-- Empty state when no meetings -->
              <tr>
                <td style="padding:12px 24px 16px 24px;">
                  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse; background:#ffffff; border:1px solid #e5e7eb; border-radius:10px;">
                    <tr>
                      <td style="padding:20px 16px; text-align:center;">
                        <div style="font-size:16px; font-weight:600; color:#6b7280; margin-bottom:8px;">No meetings for this date.</div>
                        <div style="font-size:13px; color:#9ca3af;">Check your calendar or try a different date.</div>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            {% endif %}

            {% if research is defined and (app_env|default('') == 'development' or enable_research_dev|default(false)) %}
            <!-- Research (dev/debug only - per-meeting research is now in meeting cards) -->
            <tr>
              <td style="padding:16px 24px 0 24px;">
                {% if research.summary or (research.key_points|default([])|length > 0) or (research.sources|default([])|length > 0) %}
                <div style="font-weight:800; font-size:15px; color:#111827; margin-bottom:10px;">Research (Debug)</div>
                {% if research.summary %}
                <p style="margin:0 0 10px 0; font-size:13px; color:#374151; line-height:1.5;">{{ research.summary }}</p>
                {% endif %}
                {% if research.key_points and research.key_points|length > 0 %}
                <ul style="margin:0 0 10px 0; padding-left:18px; font-size:13px; color:#374151;">
                  {% for point in research.key_points %}
                  <li style="margin:4px 0;">{{ point }}</li>
                  {% endfor %}
                </ul>
                {% endif %}
                {% if research.sources and research.sources|length > 0 %}
                <div style="font-size:13px;">
                  {% for s in research.sources %}
                  {% if s.url and s.title %}
                  <div style="margin:4px 0;"><a href="{{ s.url }}" target="_blank" rel="noopener noreferrer" style="color:#3a5d80; text-decoration:underline;">{{ s.title }}</a></div>
                  {% endif %}
                  {% endfor %}
                </div>
                {% endif %}
                {% else %}
                <div style="font-weight:800; font-size:15px; color:#111827; margin-bottom:10px;">Research (Debug)</div>
                <p style="margin:0 0 10px 0; font-size:13px; color:#6b7280; line-height:1.5;">Research not included for this briefing. No high-confidence external meeting was detected.</p>
                {% endif %}
              </td>
            </tr>
            {% endif %}

            <!-- Footer -->
            <tr>
              <td style="padding:20px 24px 24px 24px; color:#6b7280; font-size:12px;">
                <div style="border-top:1px solid #e5e7eb; padding-top:12px;">
                  © {{ current_year or "2025" }} RPCK Rastegar Panchal LLP — Internal briefing. If anything looks off, reply and I’ll regenerate with fixes.
                </div>
              </td>
            </tr>
          </table>
          <div style="height:12px; line-height:12px; font-size:12px;">&nbsp;</div>
        </td>
      </tr>
    </table>
  </body>
</html>
